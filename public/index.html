<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Supermarket</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:900,700,600,400,300">
	<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

	<link rel="stylesheet" type="text/css" href="assets/style/reset.css">
	<link rel="stylesheet" type="text/css" href="assets/style/fonts/galano/galano.css">
	<link rel="stylesheet" type="text/css" href="assets/style/fonts/icon-12/icon-12.css">
	<link rel="stylesheet" type="text/css" href="assets/style/fonts/icon-16/icon-16.css">
	<link rel="stylesheet" type="text/css" href="assets/style/main.css">
	<link rel="stylesheet" type="text/css" href="assets/style/cards.css">

</head>
<body id="products" class="white">

	<header>
		<div class="logo">
			<img src="assets/style/images/apple.svg" />
		</div>
	</header>

	<main class="main-content">

		<div class="tab-filter-wrapper">
			<div class="tab-filter">
				<ul class="filters">
					<li class="filter">
						<a data-menu="" href="javascript:filter('');">All</a>
					</li>
					<li class="filter">
						<a data-menu="bakery" href="javascript:filter('bakery');">Bakery</a>
					</li>
					<li class="filter">
						<a data-menu="dairy" href="javascript:filter('dairy');">Dairy</a>
					</li>
					<li class="filter">
						<a data-menu="fruit" href="javascript:filter('fruit');">Fruit</a>
					</li>
					<li class="filter">
						<a data-menu="vegetable" href="javascript:filter('vegetable');">Vegetable</a>
					</li>
					<li class="filter">
						<a data-menu="meat" href="javascript:filter('meat');">Meat</a>
					</li>
					<li>
						Sopping cart: <span id="shoppingCartCount">0</span> item(s)
					</li>
				</ul>
			</div>
		</div>

		<section class="gallery">
			<ul id="productList"></ul>
			<div class="fail-message">No products found</div>
		</section>

	</main>
		
	<script src="http://cdn.wedeploy.com/api/latest/wedeploy.js"></script>
	<script>
		// Checks user is signed in ------------------------------------------------------

		var currentUser = WeDeploy.auth().currentUser;

		if (currentUser === null) {
			location.href = 'login.html';
		}

		// Helpers -----------------------------------------------------------------------

		var pendingRequest;

		function filter(type) {
			if (pendingRequest) {
				pendingRequest.cancel();
			}
			pendingRequest = WeDeploy.data('data.supermarket.wedeploy.io')
				.any('type', type ? [type] : ['vegetable', 'meat', 'bakery', 'dairy', 'fruit'])
				.get('products')
				.then(function(products) {
					plotProducts(products);
					selectActiveMenu(type);
					return this;
				});
			return pendingRequest;
		}

		function filterSimilarProducts(description) {
			if (pendingRequest) {
				pendingRequest.cancel();
			}
			pendingRequest = WeDeploy.data('data.supermarket.wedeploy.io')
				.similar(description)
				.search('products')
				.then(function(search) {
					plotProducts(search.documents);
					return this;
				});
			return pendingRequest;
		}

		function plotProducts(products) {
			var html = '';
			var list = document.getElementById('productList');
			for(var i = 0; i < products.length; i++) {
				html += '<li class="mix ' + products[i].type + '" data-title="' + products[i].title + '">';
				html += '<a href="javascript:saveItemToShoppingCart(\'' + products[i].id +'\');" class="add-to-cart">Add To Cart</a>';
				html += '<a href="javascript:filterSimilarProducts(\'' + products[i].description +'\');" class="filter-similar-products">Find similar products</a>';
				html += '<div class="bottom-info">';
				html += '<span class="title">' + products[i].title + '</span>';
				html += '<span class="price">$' + products[i].price + '</span>';
				html += '</div>';
				html += '<div class="blur"></div>';
				html += '<img src="assets/images/' + products[i].filename + '" alt="' + products[i].description + '" />';
				html += '</li>';
			}
			list.innerHTML = html;
		}

		function saveItemToShoppingCart(productId) {
			return WeDeploy.data('data.supermarket.wedeploy.io')
				.create('cart', {
					"productId": productId,
					"userId": currentUser.id
				})
				.then(function(item) {
					return loadShoppintCartCount();
				});
		}

		function loadShoppintCartCount() {
			return WeDeploy.data('data.supermarket.wedeploy.io')
				.count()
				.where('userId', currentUser.id)
				.get('cart')
				.then(function(total) {
					document.getElementById('shoppingCartCount').innerHTML = total;
					return this;
				});
		}

		function selectActiveMenu(type) {
			document.querySelectorAll('[data-menu]')
				.forEach(function(menu) {
					menu.classList.remove('selected');
					if (menu.dataset.menu === type) {
						menu.classList.add('selected');
					}
				});
		}

		function signOut() {
			WeDeploy.auth()
				.signOut()
				.then(function() {
					location.href = 'login.html';
				});
		}

		// Load items first time -------------------------------------------------------

		filter('')
			.then(function() {
				loadShoppintCartCount();
			});
	</script>
</body>
</html>
